<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make a Clip</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- This script is essential for Auth0 to work -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <!-- This loads your custom styles -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="app-title-container">
        <div class="header-container">
            <h1><i class="fa-solid fa-bolt"></i> Make a Clip</h1>
            <div class="auth-buttons">
                <button id="btn-login" class="nav-button">Log In</button>
                <button id="btn-logout" class="nav-button" style="display:none;">Log Out</button>
            </div>
        </div>
        <ul class="nav-menu">
            <li><a href="#">Text to Speech</a></li>
            <li><a href="/" class="active">Viral Editor</a></li>
            <li><a href="/pricing">Pricing</a></li>
        </ul>
    </div>
    
    <main class="editor-container">
        <p class="step-title"><span class="accent-text">Step 1:</span> Choose Your Template</p>
        <div class="selector-grid" id="template-selector">
            <div class="option-box selected" data-template="character"><i class="fa-solid fa-comments"></i><div class="label">Character Dialogue</div></div>
            <div class="option-box" data-template="reddit"><i class="fa-brands fa-reddit-alien"></i><div class="label">Reddit Stories</div></div>
        </div>
        <p class="step-title"><span class="accent-text">Step 2:</span> Choose Background Gameplay</p>
        <div class="selector-grid" id="background-selector">
            <div class="option-box selected" data-video="minecraft_parkour1"><img src="/static/minecraft1.png" alt="Minecraft Parkour"><div class="label">Minecraft Parkour</div></div>
            <div class="option-box" data-video="subway_surfers1"><img src="/static/subwaysurfer1.png" alt="Subway Surfers"><div class="label">Subway Surfers</div></div>
        </div>
        <p class="step-title"><span class="accent-text">Step 3:</span> Choose Subtitle Style</p>
        <div class="selector-grid" id="subtitle-selector">
            <div class="option-box selected" data-style="standard"><p class="subtitle-preview" id="standard-preview">Standard</p></div>
            <div class="option-box" data-style="yellow"><p class="subtitle-preview" id="yellow-preview">Yellow</p></div>
            <div class="option-box" data-style="meme"><p class="subtitle-preview" id="meme-preview">Meme</p></div>
        </div>
        <p class="step-title"><span class="accent-text">Step 4:</span> Write Your Script</p>
        <div id="dialogue-container" class="dialogue-box"></div>
        <div class="controls">
            <button id="add-dialogue-btn"><i class="fa-solid fa-plus"></i> Add Dialogue Line</button>
            <button id="generate-btn" disabled><span class="icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span><span class="text">Generate Video</span></button>
        </div>
        <div class="status" id="status-area">Please log in to generate a video.</div>
    </main>

    <template id="dialogue-row-template">
        <div class="dialogue-row">
            <select class="character-select"><option value="peter">Peter</option><option value="brian">Brian</option></select>
            <select class="placement-select"><option value="center">Center</option><option value="left">Left</option><option value="right">Right</option></select>
            <input type="text" class="dialogue-input" placeholder="Enter dialogue...">
            <button class="remove-btn" title="Remove line">Ã—</button>
        </div>
    </template>
    
    <script>
        let auth0 = null;

        const auth0Config = {
            domain: "dev-23iqnnqsp0tbnxch.us.auth0.com",
            clientId: "99E30sRywMn8h4uFwa5edAbR27F6NGzU",
            authorizationParams: {
                redirect_uri: window.location.origin,
                audience: "https://api.makeaclip.pro"
            }
        };

        // This function handles all UI events that don't need authentication
        const initializeEditor = () => {
            const dialogueContainer = document.getElementById('dialogue-container');
            const rowTemplate = document.getElementById('dialogue-row-template');
            
            const addRow = () => dialogueContainer.appendChild(rowTemplate.content.cloneNode(true));
            if (dialogueContainer.children.length === 0) { addRow(); addRow(); }
            
            document.getElementById('add-dialogue-btn').addEventListener('click', addRow);
            dialogueContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) e.target.closest('.dialogue-row').remove();
            });

            document.getElementById('generate-btn').addEventListener('click', onGenerateClick);
            
            document.querySelectorAll('.selector-grid').forEach(grid => {
                grid.addEventListener('click', (event) => {
                    const selectedOption = event.target.closest('.option-box');
                    if (!selectedOption) return;
                    grid.querySelectorAll('.option-box').forEach(opt => opt.classList.remove('selected'));
                    selectedOption.classList.add('selected');
                });
            });
        };

        // This function updates the UI based on whether the user is logged in
        const updateUI = async () => {
            const isAuthenticated = await auth0.isAuthenticated();
            document.getElementById('btn-login').style.display = isAuthenticated ? 'none' : 'block';
            document.getElementById('btn-logout').style.display = isAuthenticated ? 'block' : 'none';
            document.getElementById('generate-btn').disabled = !isAuthenticated;
            document.getElementById('status-area').textContent = isAuthenticated ? '' : 'Please log in to generate a video.';
        };
        
        // This function contains the logic for when the generate button is clicked
        const onGenerateClick = async () => {
            const isAuthenticated = await auth0.isAuthenticated();
            if (!isAuthenticated) {
                return auth0.loginWithRedirect();
            }
            // --- The rest of your video generation logic would go here ---
            // For now, it just shows an alert.
            const statusArea = document.getElementById('status-area');
            statusArea.textContent = "Starting video generation process...";
            console.log("Video generation started by authenticated user.");
        };

        // This function configures the Auth0 client and handles login/logout
        const configureAuth = async () => {
            try {
                auth0 = await createAuth0Client(auth0Config);
            } catch (e) {
                console.error("Auth0 SDK failed to load. Retrying...");
                const interval = setInterval(async () => {
                    try {
                        auth0 = await createAuth0Client(auth0Config);
                        clearInterval(interval);
                        await configureAuth(); // Re-run this function once the SDK is loaded
                    } catch (err) { /* Still not ready, wait for next interval */ }
                }, 1000);
                return;
            }

            // Set up login and logout button listeners
            document.getElementById('btn-login').addEventListener('click', () => auth0.loginWithRedirect());
            document.getElementById('btn-logout').addEventListener('click', () => auth0.logout({ logoutParams: { returnTo: window.location.origin } }));

            // Handle the redirect back from Auth0
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has("code") && urlParams.has("state")) {
                await auth0.handleRedirectCallback();
                window.history.replaceState({}, document.title, "/");
            }
            
            // Update the UI with the final auth state
            await updateUI();
        };

        // This is the main entry point when the page loads
        window.addEventListener('load', () => {
            initializeEditor(); // Set up the non-auth UI first for responsiveness
            configureAuth();    // Then configure authentication in the background
        });
    </script>
</body>
</html>
